name: Ci Test (Dynamic Variant + Custom Runner)

on:
  push:
    paths: ["src/caddy/caddy.version"]
  workflow_dispatch:
    inputs:
      dockerfile:
        description: "选择系统 (Base image type)"
        required: true
        type: choice
        default: "Dockerfile"
        options: ["Dockerfile", "Dockerfile.debian", "all"]
      web_server:
        default: "caddy"
        type: choice
        options: ["caddy", "nginx", "haproxy"]
      exit_mode:
        default: "1"
        type: choice
        options: ["0", "1", "2"]

jobs:
  # --- 第一阶段：决定跑哪些系统变体 ---
  setup:
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.decide.outputs.variants }}
    steps:
      - id: decide
        run: |
          CHOICE="${{ github.event.inputs.dockerfile }}"
          # 判断用户选了哪个系统文件
          if [ "$CHOICE" == "Dockerfile" ]; then
            V='["alpine"]'
          elif [ "$CHOICE" == "Dockerfile.debian" ]; then
            V='["debian"]'
          else
            V='["alpine", "debian"]'
          fi
          echo "variants=$V" >> $GITHUB_OUTPUT

  # --- 第二阶段：构建镜像 ---
  build:
    needs: setup
    # 这里的 runs-on 现在是动态的了，根据下面 matrix 里的 runner 定义来选
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        # 1. 系统变体从 setup 任务动态获取
        variant: ${{ fromJSON(needs.setup.outputs.variants) }}

        # 2. 这里定义平台和对应的 Runner，你可以随时修改这里
        include:
          - platform: "linux/amd64"
            runner: "ubuntu-latest" # amd64 任务用的机器
          - platform: "linux/arm64"
            runner: "ubuntu-latest" # arm64 任务用的机器（以后有 ARM 机器可以改成对应的 label）

    steps:
      - name: 下载代码
        uses: actions/checkout@v4
        with:
          repository: darkommoers/mainal
          path: mainal
          token: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: 准备 Dockerfile
        run: |
          cp -fr mainal/sap/docker/* .
          # 根据当前的变体名确定用哪个 Dockerfile
          if [ "${{ matrix.variant }}" == "alpine" ]; then
            echo "DOCKERFILE_PATH=Dockerfile" >> $GITHUB_ENV
          else
            echo "DOCKERFILE_PATH=Dockerfile.debian" >> $GITHUB_ENV
          fi

      - name: 准备环境和变量
        run: |
          # 平台名斜杠换横杠
          PLAT="${{ matrix.platform }}"
          echo "PLATFORM_PAIR=${PLAT//\//-}" >> $GITHUB_ENV

          # 镜像全名
          WS="${{ github.event.inputs.web_server || 'caddy' }}"
          EM="${{ github.event.inputs.exit_mode || '1' }}"
          echo "REGISTRY_IMAGE=ghcr.io/${{ github.repository_owner }}/sap-$WS-$EM" >> $GITHUB_ENV

      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 安装 Docker 工具
        uses: docker/setup-buildx-action@v3
      - name: 安装 QEMU (跨架构支持)
        uses: docker/setup-qemu-action@v3

      - name: 修改 Dockerfile
        run: |
          WS="${{ github.event.inputs.web_server || 'caddy' }}"
          EM="${{ github.event.inputs.exit_mode || '1' }}"
          sed -i "s/run.sh \"\$TARGETPLATFORM\" \"caddy\" \"1\"/run.sh \"\$TARGETPLATFORM\" \"$WS\" \"$EM\"/g" "${{ env.DOCKERFILE_PATH }}"

      - name: 构建并推送指纹 (Digest)
        id: build_step
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./${{ env.DOCKERFILE_PATH }}
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ env.REGISTRY_IMAGE }},push-by-digest=true,name-canonical=true,push=true

      - name: 保存指纹文件
        run: |
          mkdir -p ${{ runner.temp }}/digests
          DIGEST="${{ steps.build_step.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${DIGEST#sha256:}"

      - name: 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.variant }}-${{ env.PLATFORM_PAIR }}
          path: ${{ runner.temp }}/digests/*
          retention-days: 1

  # --- 第三阶段：合并 Manifest ---
  merges:
    needs: [setup, build]
    runs-on: ubuntu-latest # 合并任务很轻量，用官方默认机器就行
    strategy:
      matrix:
        # 同样根据变体数量跑合并任务
        variant: ${{ fromJSON(needs.setup.outputs.variants) }}
    steps:
      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 下载指纹
        uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/all-digests
          pattern: digests-${{ matrix.variant }}-*
          merge-multiple: true

      - name: 安装 Buildx
        uses: docker/setup-buildx-action@v3

      - name: 合并并发布 Tag
        run: |
          WS="${{ github.event.inputs.web_server || 'caddy' }}"
          EM="${{ github.event.inputs.exit_mode || '1' }}"
          IMG="ghcr.io/${{ github.repository_owner }}/sap-$WS-$EM"

          TAGS="-t $IMG:${{ matrix.variant }}"
          if [ "${{ matrix.variant }}" == "alpine" ]; then
            TAGS="$TAGS -t $IMG:latest"
          fi

          cd ${{ runner.temp }}/all-digests
          docker buildx imagetools create $TAGS $(printf "$IMG@sha256:%s " *)
