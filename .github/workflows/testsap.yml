name: Ci Test (Dynamic Matrix Optimized)

on:
  push:
    paths: ["src/caddy/caddy.version"]
  workflow_dispatch:
    inputs:
      dockerfile:
        description: "Base image type"
        required: true
        type: choice
        default: "Dockerfile"
        options: ["Dockerfile", "Dockerfile.debian", "all"]
      web_server:
        default: "caddy"
        type: choice
        options: ["caddy", "nginx", "haproxy"]
      exit_mode:
        default: "1"
        type: choice
        options: ["0", "1", "2"]

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.set.outputs.variants }}
    steps:
      - id: set
        run: |
          # 根据输入决定要跑哪些变体，只输出变体名数组
          case "${{ github.event.inputs.dockerfile }}" in
            "Dockerfile") V='["alpine"]' ;;
            "Dockerfile.debian") V='["debian"]' ;;
            *) V='["alpine", "debian"]' ;;
          esac
          echo "variants=$V" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 这里的 variant 是动态的，platform 是静态的
        # GitHub 会自动把它们交叉组合 (例如 alpine x amd64, alpine x arm64)
        variant: ${{ fromJSON(needs.setup.outputs.variants) }}
        platform: ["linux/amd64", "linux/arm64"]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: darkommoers/mainal
          path: mainal
          token: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: Prepare
        run: |
          cp -fr mainal/sap/docker/* .
          # 根据变体名动态确定文件名
          if [ "${{ matrix.variant }}" == "alpine" ]; then
            echo "DOCKERFILE_PATH=Dockerfile" >> $GITHUB_ENV
          else
            echo "DOCKERFILE_PATH=Dockerfile.debian" >> $GITHUB_ENV
          fi
          
          # 处理平台斜杠
          PLAT="${{ matrix.platform }}"
          echo "PLATFORM_PAIR=${PLAT//\//-}" >> $GITHUB_ENV
          
          # 镜像名称
          WS="${{ github.event.inputs.web_server || 'caddy' }}"
          EM="${{ github.event.inputs.exit_mode || '1' }}"
          echo "REGISTRY_IMAGE=ghcr.io/${{ github.repository_owner }}/sap-$WS-$EM" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./${{ env.DOCKERFILE_PATH }}
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ env.REGISTRY_IMAGE }},push-by-digest=true,name-canonical=true,push=true

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.variant }}-${{ env.PLATFORM_PAIR }}
          path: ${{ runner.temp }}/digests/*
          retention-days: 1

  merges:
    needs: [setup, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 这里只根据变体跑，所以 alpine 跑一次，debian 跑一次，绝不重复
        variant: ${{ fromJSON(needs.setup.outputs.variants) }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/all-digests
          pattern: digests-${{ matrix.variant }}-*
          merge-multiple: true

      - name: Create manifest and push
        run: |
          WS="${{ github.event.inputs.web_server || 'caddy' }}"
          EM="${{ github.event.inputs.exit_mode || '1' }}"
          IMG="ghcr.io/${{ github.repository_owner }}/sap-$WS-$EM"
          
          # 打标签逻辑
          TAGS="-t $IMG:${{ matrix.variant }}"
          if [ "${{ matrix.variant }}" == "alpine" ]; then TAGS="$TAGS -t $IMG:latest"; fi
          
          cd ${{ runner.temp }}/all-digests
          docker buildx imagetools create $TAGS $(printf "$IMG@sha256:%s " *)
