name: Ci Test (Fixed Static Matrix)

on:
  workflow_dispatch:
    inputs:
      dockerfile:
        description: "Base image type"
        required: true
        type: choice
        default: "Dockerfile"
        options: ["Dockerfile", "Dockerfile.debian", "all"]
      web_server:
        default: "caddy"
        type: choice
        options: ["caddy", "nginx", "haproxy"]
      exit_mode:
        default: "1"
        type: choice
        options: ["0", "1", "2"]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: alpine
            file: Dockerfile
            platform: linux/amd64
          - variant: alpine
            file: Dockerfile
            platform: linux/arm64
          - variant: debian
            file: Dockerfile.debian
            platform: linux/amd64
          - variant: debian
            file: Dockerfile.debian
            platform: linux/arm64
    runs-on: ubuntu-latest
    steps:
      # 1. 核心改动：在每个步骤增加 if 判断
      - name: Check if should run
        id: check
        run: |
          SHOULD_RUN=false
          INPUT="${{ github.event.inputs.dockerfile }}"
          VARIANT="${{ matrix.variant }}"
          if [ "$INPUT" = "all" ]; then SHOULD_RUN=true; fi
          if [ "$INPUT" = "Dockerfile" ] && [ "$VARIANT" = "alpine" ]; then SHOULD_RUN=true; fi
          if [ "$INPUT" = "Dockerfile.debian" ] && [ "$VARIANT" = "debian" ]; then SHOULD_RUN=true; fi
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      - name: Checkout private repo
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          repository: darkommoers/mainal
          path: mainal
          token: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: Build and Push
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Building ${{ matrix.variant }} for ${{ matrix.platform }}..."
          # 这里放你之前的 docker build 逻辑
          
      - name: Upload digest
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.variant }}-${{ matrix.platform }} # 注意这里平台名需要处理一下斜杠
          path: /tmp/digests/* # 示例路径

  merges:
    needs: build
    strategy:
      matrix:
        variant: [alpine, debian]
    runs-on: ubuntu-latest
    steps:
      - name: Check if should run
        id: check
        run: |
          SHOULD_RUN=false
          INPUT="${{ github.event.inputs.dockerfile }}"
          VARIANT="${{ matrix.variant }}"
          if [ "$INPUT" = "all" ]; then SHOULD_RUN=true; fi
          if [ "$INPUT" = "Dockerfile" ] && [ "$VARIANT" = "alpine" ]; then SHOULD_RUN=true; fi
          if [ "$INPUT" = "Dockerfile.debian" ] && [ "$VARIANT" = "debian" ]; then SHOULD_RUN=true; fi
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      - name: Merge Manifests
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Merging for ${{ matrix.variant }}..."
